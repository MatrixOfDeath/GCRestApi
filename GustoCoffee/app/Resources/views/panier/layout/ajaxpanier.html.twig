{% set totalProduitHT = 0 %}
{% set totalSalleHT = 0 %}
{% set totalProduitTTC =  0 %}
{% set totalSalleTTC = 0 %}
{% set refTva = {} %}
{% set refSalleTva = {} %}
{% for produit in produits %}
    {% set refTva = refTva|merge({ ('%' ~ produit.tva.valeur) : 0 }) %}
{% endfor %}
{% for salle in salles %}
    {% set refSalleTva = refSalleTva|merge({ ('%' ~ salle.tva.valeur) : 0 }) %}
{% endfor %}

        <div class="col-xs-12">
            
            {% for flashMessage in app.session.flashbag.get('success') %}
                <div class="alert alert-success">
                    {{ flashMessage }}
                </div>
            {% endfor %}

            {% for flashMessage in app.session.flashbag.get('error') %}
                <div class="alert alert-error">
                    {{ flashMessage }}
                </div>
            {% endfor %}
            
            <h2>Votre panier</h2>

            <table class="table table-striped table-hover">
                <thead>
                <tr>
                    <th>Salle choisi</th>
                    <th>Nombre d'heures</th>
                    <th>Prix à l'heure</th>
                    <th>Total TTC</th>
                </tr>
                </thead>
                <tbody>
                {% if salles|length == 0 %}
                    <tr>
                        <td colspan="4"><center>Aucune salle sélectionner dans votre panier</center></td>
                    </tr>
                {% endif %}
                {# @var salle \AppBundle\Entity\Salle #}
                {%  for salle in salles %}
                    <tr>
                        {#<form action="{{ path('ajout_panier_salle', { 'id' : salle.idsalle }) }}" method="get">#}
                            <td>{{ salle.nomsalle }}</td>
                            <td>
                                {{ "De " ~ panier_salle[salle.idsalle].heureChoixDebut|date('h:i') ~ " à " ~ panier_salle[salle.idsalle].heureChoixFin|date('h:i') ~ ' Temps:' ~ panier_salle[salle.idsalle].totalHeures ~ 'H' }}
                                //On ajoute 2e par personne pour la demi-heure supplémentaire
                                {% if panier_salle[salle.idsalle].totalMinutes >= 30 %}
                                    {% set totalMinutes = totalSalleTTC + (2 * salle.capacitymax ) %}
                                    {{ panier_salle[salle.idsalle].totalMinutes ~ 'min' }}
                                {% else %}
                                    {% set totalMinutes = 0 %}
                                {% endif %}

                                {#<a href="{{ path('delete_panier_salle', { 'id' : salle.idsalle }) }}"><i class="glyphicon glyphicon-trash"></i></a>#}
                                <button type="button" class="buttonDeleteSalle glyphicon glyphicon-trash" value="{{ salle.idsalle }}" ></button>
                            </td>
                            <td>{{ salle.prixsalle }} €</td>
                            {% if panier_salle[salle.idsalle].totalHeures >= 5 %}
                                <td>{{ salle.prixsalle * 4 }} €</td>
                                {% set totalSalleTTC =  totalSalleTTC + salle.prixsalle * 4 %}
                            {% elseif panier_salle[salle.idsalle].totalHeures == 3 %}
                                <td>{{ salle.prixsalle * 2 }} €</td>
                                {% set totalSalleTTC =  totalSalleTTC + salle.prixsalle * 2  + totalMinutes %}
                            {% else %}
                                <td>{{ salle.prixsalle * panier_salle[salle.idsalle].totalHeures + totalMinutes }} €</td>
                                {% set totalSalleTTC =  totalSalleTTC + salle.prixsalle * panier_salle[salle.idsalle].totalHeures + totalMinutes %}
                            {% endif %}

                        {#</form>#}
                    </tr>
                    {#{% set totalSalleHT = totalSalleHT + (salle.prixsalle * panier_salle[salle.idsalle].totalHeures) %}#}
                    {#{% set totalSalleTTC = totalSalleTTC + (salle.prixsalle * panier_salle[salle.idsalle].totalHeures)|tva(salle.tva.multiplicate) * panier_salle[salle.idsalle].totalHeures %}#}

                    {% if panier_salle[salle.idsalle].totalMinutes >= 30 %}
                        {% set totalSalleTTC = totalSalleTTC + (2 * salle.capacitymax ) %}
                    {% endif %}
                    {% set refSalleTva = refSalleTva|merge({ ('%' ~ salle.tva.valeur) : refSalleTva['%' ~ salle.tva.valeur] + ( salle.prixsalle * panier_salle[salle.idsalle].totalHeures)|montantTva(salle.tva.multiplicate) }) %}

                    {#{% set totalSalleTTC =  totalSalleTTC +  salle.prixsalle * panier_salle[salle.idsalle].totalHeures %}#}
                {%  endfor %}
                </tbody>
            </table>
            <table class="table table-striped table-hover">
                <thead>
                    <tr>
                        <th>Références</th>
                        <th>Quantité</th>
                        <th>Prix unitaire</th>
                        <th>Total HT</th>
                    </tr>
                </thead>
                <tbody>

                    {% if produits|length == 0 %}
                        <tr>
                            <td colspan="4"><center>Aucun articles dans votre panier</center></td>
                        </tr>
                    {% endif %}

                    {% for produit in produits %}
                        <tr>
                            {#<form action="{{ path('ajout_panier', { 'id' : produit.idproduit }) }}" method="get">#}
                                <td>{{ produit.nomproduit }}</td>
                                <td>
                                    <select name="qte" class="span1 select-qte-produit">
                                        {% for i in 1..10 %}
                                            <option value="{{ i }}" {% if i == panier[produit.idproduit] %} selected="selected" {% endif %}>{{ i }}</option>
                                        {% endfor %}
                                    </select>
                                    {#<a href="{{ path('delete_panier', { 'id' : produit.idproduit }) }}"><i class="glyphicon glyphicon-trash"></i></a>#}
                                    <button type="button" class="buttonDeleteProduit glyphicon glyphicon-trash" value="{{ produit.idproduit }}" ></button>
                                </td>
                                <td>{{ produit.prixproduit }} €</td>
                                <td>{{ produit.prixproduit * panier[produit.idproduit] }} €</td>
                            {#</form>#}
                        </tr>
                        {% set totalProduitHT = totalProduitHT + (produit.prixproduit * panier[produit.idproduit]) %}
                        {% set totalProduitTTC = totalProduitTTC + (produit.prixproduit * panier[produit.idproduit])|tva(produit.tva.multiplicate) %}
                        {% set refTva = refTva|merge({ ('%' ~ produit.tva.valeur) : refTva['%' ~ produit.tva.valeur] + ( produit.prixproduit * panier[produit.idproduit])|montantTva(produit.tva.multiplicate) }) %}
                    {% endfor %}
                </tbody>
            </table>
            {% if produits|length != 0 or salles|length != 0 %}
            <dl class="dl-horizontal pull-right">
                <dt>Total HT :</dt><dd>{{ (totalProduitHT + totalSalleTTC)|number_format(2, '.', ',')  }}€</dd>
                {% for key, tva in refTva %}
                    <dt>TVA {{ key }} :</dt><dd>{{ tva }} €</dd>
                {% endfor %}
                {% for key, tva in refSalleTva %}
                    <dt>dont {{ key }} TVA Salle:</dt><dd>{{ tva }} €</dd>
                {% endfor %}
                 {% if produits|length != 0 and salles|length != 0 %}
                     <dt>Sous-Total TTC :</dt><dd>{{ (totalProduitTTC + totalSalleTTC)|number_format(2, '.', ',') }} €</dd>
                     <dt class="reduction-10">Réduction -10% :</dt><dd class="reduction-10">-{{ ((totalProduitTTC + totalSalleTTC) * 0.1)|number_format(2, '.', ',') }} €</dd>
                     <dt>Montant Total TTC :</dt><dd>{{ ((totalProduitTTC + totalSalleTTC)  - ((totalProduitTTC + totalSalleTTC) * 0.1))|number_format(2, '.', ',') }} €</dd>
                 {% else %}
                <dt class="montant-total">Montant Total TTC :</dt><dd class="montant-total">{{ (totalProduitTTC + totalSalleTTC)|number_format(2, '.', ',') }} €</dd>
                 {% endif %}
            </dl>
            <div class="clearfix"></div>
            <a href="{{ path('livraison_panier') }}" class="btn btn-success pull-right">Valider mon panier</a>
            {% endif %}
            {% if salles|length == 0 %}
            <a href="{{ path('salle_index') }}" class="btn btn-primary">Choisissez une salle</a>
            {% else %}
             <a href="{{ path('produits_index') }}" class="btn btn-primary">Choisir mes produits</a>
            {% endif %}
        </div>

